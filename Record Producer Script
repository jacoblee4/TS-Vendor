var remit = new GlideRecord('x_banun_submit_a_0_coupa_suppliers_remit_to_address');
remit.get(producer.remit_to_address);

var supplier_name = remit.sys_id;
var address_line_1 = remit.address_street_1;

var invoice_numbers = producer.invoice_numbers.toString().split(',');
var invoice_amounts = producer.invoice_amounts.toString().split(',');
var attachment_ids = producer.attachment_ids.toString().split(',');
var invoice_pdf_dates = producer.invoice_pdf_dates.toString().split(',');
var invoice_credit_variable = producer.invoice_credit_variable.toString().split(',');
var invoice_lines = [];

for (var i = 0; i < invoice_numbers.length; i++) {
    var gr = new GlideRecord('x_banun_submit_a_0_new_invoice_submission');
    gr.initialize();
    gr.requested_by = producer.requested_by;
    gr.invoice_date = producer.invoice_date;
    gr.invoice_account_toggle = producer.invoice_account_toggle;
    gr.supplier_name = supplier_name;
    gr.remit_to_address = address_line_1;
    gr.invoice_number = invoice_numbers[i];
    gr.invoice_total = invoice_amounts[i];
    gr.invoice_credit_variable = invoice_credit_variable[i];
    
    if (invoice_credit_variable[i] === 'credit' && invoice_pdf_dates[i]) {
        gr.invoice_pdf_date = invoice_pdf_dates[i];
    } else {
        gr.invoice_pdf_date = producer.invoice_pdf_date;
    }
    
    var invoice_id = gr.insert();
    invoice_lines.push(invoice_id);
}

linkAttachments();

current.setAbortAction(true);
producer.portal_redirect = "?id=vendorprogram_home";

function linkAttachments() {
    for (var i = 0; i < invoice_lines.length; i++) {
        if (attachment_ids[i] != 'copied') {
            var gr = new GlideRecord('sys_attachment');
            gr.addQuery('table_sys_id', attachment_ids[i]);
            gr.query();

            while (gr.next()) {
                gr.table_sys_id = invoice_lines[i];
                gr.update();
            }
        }
    }
}
