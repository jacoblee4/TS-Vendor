var remit = new GlideRecord('x_banun_submit_a_0_coupa_suppliers_remit_to_address');
remit.get(producer.remit_to_address);

var supplier_name = remit.sys_id;
var address_line_1 = remit.address_street_1;

var invoice_numbers = producer.invoice_numbers.toString().split(',');
var invoice_amounts = producer.invoice_amounts.toString().split(',');
var attachment_ids = producer.attachment_ids.toString().split(',');
var invoice_pdf_dates = producer.invoice_pdf_dates.toString().split(',');
var invoice_credit_variables = producer.invoice_credit_variables.toString().split(',');
var related_invoice_numbers = producer.related_invoice_numbers.toString().split(',');
var related_pdf_dates = producer.related_pdf_dates.toString().split(',');  // NEW

var invoiceSysIdMap = {}; // Map invoice_number -> sys_id
var invoice_lines = [];

// STEP 1: Create all invoices first and build the map
for (var i = 0; i < invoice_numbers.length; i++) {
    if (invoice_credit_variables[i] == 'invoice') {
        var invGR = new GlideRecord('x_banun_submit_a_0_new_invoice_submission');
        invGR.initialize();
        invGR.requested_by = producer.requested_by;
        invGR.invoice_date = producer.invoice_date;
        invGR.invoice_account_toggle = producer.invoice_account_toggle;
        invGR.supplier_name = supplier_name;
        invGR.remit_to_address = address_line_1;
        invGR.invoice_pdf_date = invoice_pdf_dates[i];
        invGR.original_invoice_number = invoice_numbers[i];
        
        if (producer.partial_pay_indicator == 'Yes') {
            invGR.partialpay_type = producer.partialpay_type;
            invGR.partial_pay_indicator = producer.partial_pay_indicator;
        }
        
        invGR.invoice_total = invoice_amounts[i];
        invGR.invoice_credit_variable = 'invoice';
        
        var invoiceSysId = invGR.insert();
        invoice_lines.push(invoiceSysId);
        
        // Store mapping: original invoice number -> sys_id
        invoiceSysIdMap[invoice_numbers[i]] = invoiceSysId;
    }
}

// STEP 2: Create credits and link them using related_invoice field
var creditIndex = 0;
for (var j = 0; j < invoice_credit_variables.length; j++) {
    if (invoice_credit_variables[j] == 'credit') {
        var creditGR = new GlideRecord('x_banun_submit_a_0_new_invoice_submission');
        creditGR.initialize();
        creditGR.requested_by = producer.requested_by;
        creditGR.invoice_date = producer.invoice_date;
        creditGR.invoice_account_toggle = producer.invoice_account_toggle;
        creditGR.supplier_name = supplier_name;
        creditGR.remit_to_address = address_line_1;
        creditGR.invoice_pdf_date = invoice_pdf_dates[j];
        creditGR.original_invoice_number = invoice_numbers[j];
        creditGR.credit_memo = invoice_amounts[j];
        creditGR.invoice_credit_variable = 'credit';
        
        // NEW: Populate related_invoice_number and related_pdf_date fields
        var relatedInvNum = related_invoice_numbers[creditIndex];
        if (relatedInvNum) {
            creditGR.related_invoice_number = relatedInvNum;  // NEW: String field
            
            if (related_pdf_dates[creditIndex]) {
                creditGR.related_pdf_date = related_pdf_dates[creditIndex];  // NEW: Date field
            }
            
            // Link to the invoice sys_id via reference field
            if (invoiceSysIdMap[relatedInvNum]) {
                creditGR.related_invoice = invoiceSysIdMap[relatedInvNum];
            }
        }
        
        var creditSysId = creditGR.insert();
        invoice_lines.push(creditSysId);
        creditIndex++;
    }
}

linkAttachments();

current.setAbortAction(true);
producer.portal_redirect = "?id=vendorprogram_home";

function linkAttachments() {
    for (var i = 0; i < invoice_lines.length; i++) {
        if (attachment_ids[i] != 'copied') {
            var gr = new GlideRecord('sys_attachment');
            gr.addQuery('table_sys_id', attachment_ids[i]);
            gr.query();

            while (gr.next()) {
                gr.table_sys_id = invoice_lines[i];
                gr.update();
            }
        }
    }
}
