//HTML

<h4>Invoices</h4>
<div class="form-group" ng-repeat="row in data.invoice_rows track by $index">
  <hr style="border-width: 1px;" ng-if="$index > 0">
  
  <span class="fa fa-asterisk mandatory" ng-class="{'mandatory-filled': row.invoice_pdf_date != ''}"
        title="Required" style="padding-right: 0.25em;" aria-label="Required Filled "
        aria-hidden="false"></span>
  <label>Invoice Date</label>
  <div class="info-text">Enter the Invoice Date located on the PDF</div>
  <input type="date" class="form-control" ng-model="row.invoice_pdf_date" ng-change="refreshVariables()"/>
  
  <div style="margin-top:7px;">
    <span class="fa fa-asterisk mandatory" ng-class="{'mandatory-filled': row.invoice_number != ''}"
          title="Required" style="padding-right: 0.25em;" aria-label="Required Filled "
          aria-hidden="false"></span>
    <label>Invoice/Account Number</label>
    <input type="text" class="form-control" ng-model="row.invoice_number" ng-change="refreshVariables()"/>
  </div>
  
  <div style="margin-top:7px;">
    <span class="fa fa-asterisk mandatory" ng-class="{'mandatory-filled': row.invoice_amount != ''}"
          title="Required" style="padding-right: 0.25em;" aria-label="Required Filled "
          aria-hidden="false"></span>
    <label>Invoice/Account Amount</label>
    <input type="text" class="form-control" ng-model="row.invoice_amount" ng-change="refreshVariables()" ng-blur="validateCurrency(row.invoice_amount, 'invoiceAmount', row.id, 'invoice')"/>
    <div class="error-message" ng-show="row.show_invoice_error">{{row.invoice_error}}</div>
  </div>
  
  <div class="text-right" style="margin-top:15px;vertical-align:center;">
    <button class="panel-button sp-attachment-add btn btn-link attachment-btn"
            ng-click="setCurrentID(row.id, $event);">
      <span class="fa fa-asterisk mandatory" ng-class="{'mandatory-filled': row.attachmentCount > 0}"
            title="Required" style="padding-right: 0.25em;" aria-label="Required Filled "></span>
      <span class="glyphicon glyphicon-paperclip">
        <span class="badge badge-error" ng-if="row.attachmentCount > 0">{{row.attachmentCount}}</span>
      </span>
    </button>
    <button class="btn btn-danger" ng-click="deleteRow($index, row.id, 'invoice')" ng-if="$index > 0">Delete</button>
  </div>
</div>
<button class='btn btn-primary' id='Add' ng-click="addRow('invoice')">Add Invoice/Account</button>

<hr style="border-width: 1px; margin-top: 30px; margin-bottom: 20px;">

<h4>Credits</h4>
<div class="form-group" ng-repeat="row in data.credit_rows track by $index">
  <hr style="border-width: 1px;" ng-if="$index > 0">
  
  <span class="fa fa-asterisk mandatory" ng-class="{'mandatory-filled': row.invoice_pdf_date != ''}"
        title="Required" style="padding-right: 0.25em;" aria-label="Required Filled "
        aria-hidden="false"></span>
  <label>Date on PDF</label>
  <input type="date" class="form-control" ng-model="row.invoice_pdf_date" ng-change="refreshVariables()"/>
  
  <div style="margin-top:7px;">
    <span class="fa fa-asterisk mandatory" ng-class="{'mandatory-filled': row.invoice_number != ''}"
          title="Required" style="padding-right: 0.25em;" aria-label="Required Filled "
          aria-hidden="false"></span>
    <label>Credit Memo Invoice/Account Number</label>
    <input type="text" class="form-control" ng-model="row.invoice_number" ng-change="refreshVariables()"/>
  </div>
  
  <div style="margin-top:7px;">
    <span class="fa fa-asterisk mandatory" ng-class="{'mandatory-filled': row.invoice_amount != ''}"
          title="Required" style="padding-right: 0.25em;" aria-label="Required Filled "
          aria-hidden="false"></span>
    <label>Credit Memo Amount</label>
    <input type="text" class="form-control" ng-model="row.invoice_amount" ng-change="refreshVariables()" ng-blur="validateCurrency(row.invoice_amount, 'invoiceAmount', row.id, 'credit')"/>
    <div class="error-message" ng-show="row.show_invoice_error">{{row.invoice_error}}</div>
  </div>
  
  <div class="text-right" style="margin-top:15px;vertical-align:center;">
    <button class="panel-button sp-attachment-add btn btn-link attachment-btn"
            ng-click="setCurrentID(row.id, $event);">
      <span class="fa fa-asterisk mandatory" ng-class="{'mandatory-filled': row.attachmentCount > 0}"
            title="Required" style="padding-right: 0.25em;" aria-label="Required Filled "></span>
      <span class="glyphicon glyphicon-paperclip">
        <span class="badge badge-error" ng-if="row.attachmentCount > 0">{{row.attachmentCount}}</span>
      </span>
    </button>
    <button class="btn btn-danger" ng-click="deleteRow($index, row.id, 'credit')" ng-if="data.credit_rows.length > 0">Delete</button>
  </div>
</div>
<button class='btn btn-danger' id='AddCredit' ng-click="addRow('credit')">Add Credit Memo</button>

<div class="warning-bubble" ng-show="showTotalError">
  <span class="glyphicon glyphicon-warning-sign" style="margin-right: 8px;"></span>
  Total of invoices and credits must be positive. Current total: <strong>{{currentTotal}}</strong>
</div>




// CSS

.attachment-btn {
    margin-left: 0;
}
.badge-error {
	background-color: #b94a48;
}

.glyphicon {
	text-align: center;
	vertical-align: middle;
}

.badge {
    font-size: .35em;
    position: absolute;
    top: -.75em;
    right: -.75em;
    width: 2em;
    height: 2em;
    text-align: center;
}

.a-viewurl {
	color: black;
}

.a-viewurl:hover {
	text-decoration: underline;
}

.error-message{
 	color:#d9534f;
	font-style: italic;
    font-size: smaller;
    background-color: transparent;
    padding: 0 !important;
    margin: 0 !important;
}

.info-text {
    color: #666;
    font-size: 0.9em;
    font-style: italic;
    margin-bottom: 5px;
}

.warning-bubble {
    background-color: #fcf8e3;
    border: 1px solid #faebcc;
    border-radius: 4px;
    color: #8a6d3b;
    padding: 12px 15px;
    margin-top: 15px;
    font-size: 1em;
    display: flex;
    align-items: center;
}

.warning-bubble .glyphicon {
    color: #f0ad4e;
}







// Server Script

(function() {

    var FILE_ICON_MAP = {
        'image/jpeg': 'fa-file-image-o',
        'image/pjpeg': 'fa-file-image-o',
        'image/tiff': 'fa-file-image-o',
        'image/png': 'fa-file-image-o',
        'image/gif': 'fa-file-image-o',
        'application/zip': 'fa-file-archive-o',
        'application/x-compressed': 'fa-file-archive-o',
        'application/x-zip-compressed': 'fa-file-archive-o',
        'application/pdf': 'fa-file-pdf-o',
        'application/vnd.openxmlformats-officedoc': 'fa-file-word-o',
        'application/msword': 'fa-file-word-o',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'fa-file-word-o',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.template': 'fa-file-word-o',
        'application/excel': 'fa-file-excel-o',
        'application/vnd.ms-excel': 'fa-file-excel-o',
        'application/x-excel': 'fa-file-excel-o',
        'application/x-msexcel': 'fa-file-excel-o',
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'fa-file-excel-o',
        'application/vnd.openxmlformats-officedocument.spreadsheetml.template': 'fa-file-excel-o',
        'application/powerpoint': 'fa-file-powerpoint-o',
        'application/vnd.ms-powerpoint': 'fa-file-powerpoint-o',
        'application/vnd.openxmlformats-officedocument.presentationml.presentation': 'fa-file-powerpoint-o',
        'application/vnd.openxmlformats-officedocument.presentationml.template': 'fa-file-powerpoint-o',
        'application/vnd.openxmlformats-officedocument.presentationml.slideshow': 'fa-file-powerpoint-o',
        'ppt': 'fa-file-powerpoint-o',
        'pptx': 'fa-file-powerpoint-o',
        'doc': 'fa-file-word-o',
        'docx': 'fa-file-word-o',
        'xls': 'fa-file-excel-o',
        'xlsx': 'fa-file-excel-o'
    };

    if (input && input.viewattachment) {
        var gr_view = new GlideRecord('sys_attachment');
        gr_view.addQuery('table_sys_id', input.viewattachment);
        gr_view.query();
        var attachments = [];
        while (gr_view.next()) {
            var attachment = {
                sys_id: gr_view.sys_id.toString(),
                file_name: gr_view.file_name.toString(),
                icon: getIcon(gr_view.content_type.toString()),
                viewUrl: '/sys_attachment.do?sys_id=' + gr_view.getValue('sys_id')
            }
            attachments.push(attachment);
        }
        data.attachments = attachments;
    }

    else if (input && input.deleteattachment) {
        var gr_delete = new GlideRecord('sys_attachment');
        if (gr_delete.get(input.deleteattachment)) {
            gr_delete.deleteRecord();
        }
    }

    else if (input && input.action == 'delete_row') {
        var gr_delete_multiple = new GlideRecord('sys_attachment');
        gr_delete_multiple.addQuery('table_sys_id', input.row_id);
        gr_delete_multiple.query();
        gr_delete_multiple.deleteMultiple();
    }

    var invoice_row = {
        id: uuidv4(),
        invoice_pdf_date: '',
        invoice_number: '',
        invoice_amount: '',
        attachmentCount: 0,
        invoice_error: 'Invalid currency format or must be positive.',
        show_invoice_error: false
    };

    data.invoice_rows = [invoice_row];
    data.credit_rows = [];

    function getIcon(content_type) {
        return FILE_ICON_MAP[content_type] || "fa-file-o";
    }

    function uuidv4() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0,
                v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }
})();





// Client Script

api.controller = function($scope, $uibModal, nowAttachmentHandler, spUtil) {
    var c = this;
    var g_form = $scope.page.g_form;

    $scope.showTotalError = false;
    $scope.currentTotal = '$0.00';

    $scope.addRow = function(type) {
        var row = {
            id: uuidv4(),
            invoice_pdf_date: '',
            invoice_number: '',
            invoice_amount: '',
            attachmentCount: 0,
            invoice_error: type === 'invoice' ? 'Invalid currency format or must be positive.' : 'Invalid currency format or must be negative.',
            show_invoice_error: false
        };

        if (type === 'invoice') {
            c.data.invoice_rows.push(row);
        } else {
            c.data.credit_rows.push(row);
        }
        refreshMandatoryFilled();
    };

    $scope.deleteRow = function(index, row_id, type) {
        c.server.get({
            action: 'delete_row',
            row_id: row_id
        });

        if (type === 'invoice') {
            c.data.invoice_rows.splice(index, 1);
        } else {
            c.data.credit_rows.splice(index, 1);
        }
        $scope.refreshVariables();
    };

    function setupAttachmentHandler() {
        $scope.attachmentHandler = new nowAttachmentHandler(appendDone, appendError);
        $scope.$on('dialog.upload_too_large.show', function(e) {
            $log.error($scope.data.largeAttachmentMsg);
            spUtil.addErrorMessage($scope.data.largeAttachmentMsg);
        });
    }

    setupAttachmentHandler();

    $scope.$watch(function() {
        return g_form.getValue('invoice_account_toggle');
    }, function(newValue, oldValue) {
        if (newValue !== oldValue && oldValue !== undefined) {
            $scope.refreshVariables();
        }
    });

    function appendDone() {
        _updateAttachmentCounter(c.data.current_row_id, 'increment');
        $scope.fetchAttachments(c.data.current_row_id);
    }

    function appendError(error) {
        console.log(error.msg + error.fileName);
    }

    $scope.setCurrentID = function(row_id, $event) {
        c.data.current_row_id = row_id;
        $scope.fetchAttachments(row_id);
        openModal('add-invoice-attachment', '');
    };

    $scope.fetchAttachments = function(row_id) {
        c.server.get({
            viewattachment: row_id
        }).then(function(response) {
            c.data.attachments = response.data.attachments;
            c.data.current_row_id = row_id;
        });
    };

    $scope.prepareAttachment = function($event) {
        var sizeLimit = 1024 * 1024 * 24;
        var current_row_id = c.data.current_row_id.toString();
        $scope.attachmentHandler.setParams('x_banun_submit_a_0_new_invoice_submission', current_row_id, sizeLimit);
        $scope.attachmentHandler.openSelector($event);
    };

    $scope.deleteAttachment = function(attachment_id) {
        c.server.get({
            deleteattachment: attachment_id
        }).then(function(response) {
            _updateAttachmentCounter(c.data.current_row_id, 'decrement');
            $scope.fetchAttachments(c.data.current_row_id);
        });
    };

    function _updateAttachmentCounter(row_id, action) {
        var allRows = c.data.invoice_rows.concat(c.data.credit_rows);
        for (var i = 0; i < allRows.length; i++) {
            if (allRows[i].id == row_id) {
                if (action == "increment") {
                    allRows[i].attachmentCount++;
                }
                if (action == "decrement") {
                    allRows[i].attachmentCount--;
                }
            }
        }
        refreshMandatoryFilled();
    }

    function openModal(template, size, callback) {
        callback = callback || false;
        c.modalInstance = $uibModal.open({
            templateUrl: template,
            scope: $scope,
            size: size
        });
        if (callback) {
            c.closedModal = c.modalInstance.closed.then(function() {
                callback();
            });
        }
    }

    $scope.closeModal = function() {
        c.modalInstance.close();
    };

    function uuidv4() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0,
                v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    function refreshMandatoryFilled() {
        var invoice_mandatory_filled = 0;
        var credit_mandatory_filled = 0;

        for (var i = 0; i < c.data.invoice_rows.length; i++) {
            var row = c.data.invoice_rows[i];
            if (row.invoice_pdf_date != '' && row.invoice_number != '' && row.invoice_amount != '' && row.attachmentCount > 0) {
                invoice_mandatory_filled++;
            }
        }

        for (var j = 0; j < c.data.credit_rows.length; j++) {
            var creditRow = c.data.credit_rows[j];
            if (creditRow.invoice_number != '' && creditRow.invoice_amount != '' && creditRow.invoice_pdf_date != '' && creditRow.attachmentCount > 0) {
                credit_mandatory_filled++;
            }
        }

        var allInvoicesFilled = (invoice_mandatory_filled == c.data.invoice_rows.length);
        var allCreditsFilled = (c.data.credit_rows.length === 0 || credit_mandatory_filled == c.data.credit_rows.length);
        
        g_form.setValue('mandatory_filled', (allInvoicesFilled && allCreditsFilled && invoiceAmountFilled && !$scope.showTotalError));
    }

    $scope.refreshVariables = function() {
        var invoiceAccountToggle = g_form.getValue('invoice_account_toggle');

        var invoice_numbers = '';
        var invoice_amounts = '';
        var attachment_ids = '';
        var invoice_pdf_dates = '';
        var invoice_credit_variables = '';

        // Process invoice rows
        for (var i = 0; i < c.data.invoice_rows.length; i++) {
            var invRow = c.data.invoice_rows[i];
            
            invoice_numbers += invRow.invoice_number + ',';
            invoice_amounts += invRow.invoice_amount + ',';
            attachment_ids += invRow.id + ',';
            invoice_pdf_dates += (invRow.invoice_pdf_date || '') + ',';
            invoice_credit_variables += 'invoice,';
        }

        // Process credit rows
        for (var j = 0; j < c.data.credit_rows.length; j++) {
            var credRow = c.data.credit_rows[j];
            invoice_numbers += credRow.invoice_number + ',';
            invoice_amounts += credRow.invoice_amount + ',';
            attachment_ids += credRow.id + ',';
            invoice_pdf_dates += (credRow.invoice_pdf_date || '') + ',';
            invoice_credit_variables += 'credit,';
        }

        // Remove trailing commas
        invoice_numbers = invoice_numbers.slice(0, -1);
        invoice_amounts = invoice_amounts.slice(0, -1);
        attachment_ids = attachment_ids.slice(0, -1);
        invoice_pdf_dates = invoice_pdf_dates.slice(0, -1);
        invoice_credit_variables = invoice_credit_variables.slice(0, -1);

        g_form.setValue('invoice_numbers', invoice_numbers);
        g_form.setValue('invoice_amounts', invoice_amounts);
        g_form.setValue('attachment_ids', attachment_ids);
        g_form.setValue('invoice_pdf_dates', invoice_pdf_dates);
        g_form.setValue('invoice_credit_variables', invoice_credit_variables);

        calculateTotal();
        refreshMandatoryFilled();
    };

    function calculateTotal() {
        var total = 0;
        
        for (var i = 0; i < c.data.invoice_rows.length; i++) {
            var amount = parseFloat(c.data.invoice_rows[i].invoice_amount.replace(/,/g, '')) || 0;
            total += amount;
        }
        
        for (var j = 0; j < c.data.credit_rows.length; j++) {
            var creditAmount = parseFloat(c.data.credit_rows[j].invoice_amount.replace(/,/g, '')) || 0;
            total += creditAmount;
        }
        
        $scope.currentTotal = '$' + total.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        $scope.showTotalError = (total <= 0 && c.data.credit_rows.length > 0);
    }

    var invoiceAmountFilled = false;

    $scope.validateCurrency = function(value, field, row_id, type) {
        var currencyRegex = /^-?(((\d{1,3},?)(\d{3},?)+|\d{1,3})|\d+)(\.\d{2})?$/;
        var allRows = c.data.invoice_rows.concat(c.data.credit_rows);

        if (!value || !currencyRegex.test(value)) {
            invoiceAmountFilled = false;
            for (var i = 0; i < allRows.length; i++) {
                if (allRows[i].id == row_id) {
                    allRows[i].show_invoice_error = true;
                }
            }
        } else {
            var numValue = parseFloat(value.replace(/,/g, ''));
            
            if ((type === 'invoice' && numValue <= 0) || (type === 'credit' && numValue >= 0)) {
                invoiceAmountFilled = false;
                for (var j = 0; j < allRows.length; j++) {
                    if (allRows[j].id == row_id) {
                        allRows[j].show_invoice_error = true;
                    }
                }
            } else {
                invoiceAmountFilled = true;
                for (var k = 0; k < allRows.length; k++) {
                    if (allRows[k].id == row_id) {
                        allRows[k].show_invoice_error = false;
                    }
                }
            }
        }
        
        calculateTotal();
        refreshMandatoryFilled();
    };
};
