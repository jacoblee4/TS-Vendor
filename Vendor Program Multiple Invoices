//HTML

<h4>Invoice Submissions</h4>

<div class="form-group" ng-repeat="row in data.invoice_rows track by $index">
  <hr style="border-width: 2px; margin-top: 30px; margin-bottom: 20px;" ng-if="$index > 0">
  
  <h5 style="margin-bottom: 15px;">Invoice/Account #{{$index + 1}}</h5>
  
  <div class="row">
    <!-- LEFT SIDE: Invoice Section -->
    <div class="col-md-6">
      <div style="border-right: 1px solid #ddd; padding-right: 15px;">
        <h6 style="font-weight: bold; margin-bottom: 15px;">Invoice Details</h6>
        
        <span class="fa fa-asterisk mandatory" ng-class="{'mandatory-filled': isDateFilled(row.invoice_pdf_date)}"
              title="Required" style="padding-right: 0.25em;" aria-label="Required"></span>
        <label>Invoice Date</label>
        <div class="info-text">Enter the Invoice Date located on the PDF</div>
        <input type="date" class="form-control" ng-model="row.invoice_pdf_date" ng-change="refreshVariables()"/>
        
        <div style="margin-top:7px;">
          <span class="fa fa-asterisk mandatory" ng-class="{'mandatory-filled': row.invoice_number != ''}"
                title="Required" style="padding-right: 0.25em;" aria-label="Required"></span>
          <label>Invoice/Account Number</label>
          <input type="text" class="form-control" ng-model="row.invoice_number" ng-change="refreshVariables()"/>
        </div>
        
        <div style="margin-top:7px;">
          <span class="fa fa-asterisk mandatory" ng-class="{'mandatory-filled': isAmountFilled(row.invoice_amount, 'invoice')}"
                title="Required" style="padding-right: 0.25em;" aria-label="Required"></span>
          <label>Invoice/Account Amount</label>
          <input type="text" class="form-control" ng-model="row.invoice_amount" 
                 ng-change="refreshVariables()" 
                 ng-blur="validateCurrency(row.invoice_amount, 'invoiceAmount', row.id, 'invoice')"/>
          <div class="error-message" ng-show="row.show_invoice_error">{{row.invoice_error}}</div>
        </div>
        
        <div class="text-right" style="margin-top:15px;">
          <button class="panel-button sp-attachment-add btn btn-link attachment-btn"
                  ng-click="setCurrentID(row.id, $event);">
            <span class="fa fa-asterisk mandatory" ng-class="{'mandatory-filled': row.attachmentCount > 0}"
                  title="Required" style="padding-right: 0.25em;" aria-label="Required"></span>
            <span class="glyphicon glyphicon-paperclip">
              <span class="badge badge-error" ng-if="row.attachmentCount > 0">{{row.attachmentCount}}</span>
            </span>
          </button>
        </div>
      </div>
    </div>
    
    <!-- RIGHT SIDE: Credit Section -->
    <div class="col-md-6">
      <div style="padding-left: 15px;">
        <!-- Add Credit Button (shown when no credit at this index) -->
        <div ng-if="!data.credit_rows[$index] || !data.credit_rows[$index].has_credit">
          <button class="btn btn-danger" ng-click="addCreditAtIndex($index)">
            <span class="glyphicon glyphicon-plus"></span> Add Credit Memo
          </button>
        </div>
        
        <!-- Credit Fields (shown when credit exists at this index) -->
        <div ng-if="data.credit_rows[$index] && data.credit_rows[$index].has_credit">
          <h6 style="font-weight: bold; margin-bottom: 15px;">Credit Memo Details</h6>
          
          <span class="fa fa-asterisk mandatory" ng-class="{'mandatory-filled': isDateFilled(data.credit_rows[$index].invoice_pdf_date)}"
                title="Required" style="padding-right: 0.25em;" aria-label="Required"></span>
          <label>Invoice Date</label>
          <div class="info-text">Enter the Invoice Date located on the PDF</div>
          <input type="date" class="form-control" ng-model="data.credit_rows[$index].invoice_pdf_date" ng-change="refreshVariables()"/>
          
          <div style="margin-top:7px;">
            <span class="fa fa-asterisk mandatory" ng-class="{'mandatory-filled': data.credit_rows[$index].invoice_number != ''}"
                  title="Required" style="padding-right: 0.25em;" aria-label="Required"></span>
            <label>Credit Memo Invoice/Account Number</label>
            <input type="text" class="form-control" ng-model="data.credit_rows[$index].invoice_number" ng-change="refreshVariables()"/>
          </div>
          
          <div style="margin-top:7px;">
            <span class="fa fa-asterisk mandatory" ng-class="{'mandatory-filled': isAmountFilled(data.credit_rows[$index].invoice_amount, 'credit')}"
                  title="Required" style="padding-right: 0.25em;" aria-label="Required"></span>
            <label>Credit Memo Amount</label>
            <input type="text" class="form-control" ng-model="data.credit_rows[$index].invoice_amount" 
                   ng-change="refreshVariables()" 
                   ng-blur="validateCurrency(data.credit_rows[$index].invoice_amount, 'invoiceAmount', data.credit_rows[$index].id, 'credit', $index)"/>
            <div class="error-message" ng-show="data.credit_rows[$index].show_invoice_error">{{data.credit_rows[$index].invoice_error}}</div>
          </div>
          
          <div class="text-right" style="margin-top:15px;">
            <button class="panel-button sp-attachment-add btn btn-link attachment-btn"
                    ng-click="setCurrentID(data.credit_rows[$index].id, $event);">
              <span class="fa fa-asterisk mandatory" ng-class="{'mandatory-filled': data.credit_rows[$index].attachmentCount > 0}"
                    title="Required" style="padding-right: 0.25em;" aria-label="Required"></span>
              <span class="glyphicon glyphicon-paperclip">
                <span class="badge badge-error" ng-if="data.credit_rows[$index].attachmentCount > 0">{{data.credit_rows[$index].attachmentCount}}</span>
              </span>
            </button>
          </div>
          
          <div style="margin-top:15px;">
            <button class="btn btn-warning btn-sm" ng-click="removeCreditAtIndex($index)">
              <span class="glyphicon glyphicon-remove"></span> Remove Credit Memo
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Per-group error message -->
  <div class="warning-bubble" ng-show="data.credit_rows[$index] && data.credit_rows[$index].show_group_error" style="margin-top: 15px;">
    <span class="glyphicon glyphicon-warning-sign" style="margin-right: 8px;"></span>
    The credit amount cannot exceed invoice amount. Current total: <strong>{{data.credit_rows[$index].currentTotal}}</strong>
  </div>
  
  <!-- Delete Invoice Group Button -->
  <div class="text-right" style="margin-top: 15px;" ng-if="data.invoice_rows.length > 1">
    <button class="btn btn-danger" ng-click="deleteInvoiceGroup($index)">
      <span class="glyphicon glyphicon-trash"></span> Delete Invoice/Account Group
    </button>
  </div>
</div>

<button class='btn btn-primary' id='AddInvoiceGroup' ng-click="addInvoiceGroup()" 
        ng-hide="hideAddInvoiceButton" style="margin-top: 20px;">
  <span class="glyphicon glyphicon-plus"></span> Add Another Invoice/Account
</button>




// CSS

.attachment-btn {
    margin-left: 0;
}
.badge-error {
	background-color: #b94a48;
}

.glyphicon {
	text-align: center;
	vertical-align: middle;
}

.badge {
    font-size: .35em;
    position: absolute;
    top: -.75em;
    right: -.75em;
    width: 2em;
    height: 2em;
    text-align: center;
}

.a-viewurl {
	color: black;
}

.a-viewurl:hover {
	text-decoration: underline;
}

.error-message{
 	color:#d9534f;
	font-style: italic;
    font-size: smaller;
    background-color: transparent;
    padding: 0 !important;
    margin: 0 !important;
}

.info-text {
    color: #666;
    font-size: 0.9em;
    font-style: italic;
    margin-bottom: 5px;
}

.warning-bubble {
    background-color: #fcf8e3;
    border: 1px solid #faebcc;
    border-radius: 4px;
    color: #8a6d3b;
    padding: 12px 15px;
    margin-top: 15px;
    font-size: 1em;
    display: flex;
    align-items: center;
}

.warning-bubble .glyphicon {
    color: #f0ad4e;
}






// Server Script

(function() {

    var FILE_ICON_MAP = {
        'image/jpeg': 'fa-file-image-o',
        'image/pjpeg': 'fa-file-image-o',
        'image/tiff': 'fa-file-image-o',
        'image/png': 'fa-file-image-o',
        'image/gif': 'fa-file-image-o',
        'application/zip': 'fa-file-archive-o',
        'application/x-compressed': 'fa-file-archive-o',
        'application/x-zip-compressed': 'fa-file-archive-o',
        'application/pdf': 'fa-file-pdf-o',
        'application/vnd.openxmlformats-officedoc': 'fa-file-word-o',
        'application/msword': 'fa-file-word-o',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'fa-file-word-o',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.template': 'fa-file-word-o',
        'application/excel': 'fa-file-excel-o',
        'application/vnd.ms-excel': 'fa-file-excel-o',
        'application/x-excel': 'fa-file-excel-o',
        'application/x-msexcel': 'fa-file-excel-o',
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'fa-file-excel-o',
        'application/vnd.openxmlformats-officedocument.spreadsheetml.template': 'fa-file-excel-o',
        'application/powerpoint': 'fa-file-powerpoint-o',
        'application/vnd.ms-powerpoint': 'fa-file-powerpoint-o',
        'application/vnd.openxmlformats-officedocument.presentationml.presentation': 'fa-file-powerpoint-o',
        'application/vnd.openxmlformats-officedocument.presentationml.template': 'fa-file-powerpoint-o',
        'application/vnd.openxmlformats-officedocument.presentationml.slideshow': 'fa-file-powerpoint-o',
        'ppt': 'fa-file-powerpoint-o',
        'pptx': 'fa-file-powerpoint-o',
        'doc': 'fa-file-word-o',
        'docx': 'fa-file-word-o',
        'xls': 'fa-file-excel-o',
        'xlsx': 'fa-file-excel-o'
    };

    if (input && input.viewattachment) {
        var gr_view = new GlideRecord('sys_attachment');
        gr_view.addQuery('table_sys_id', input.viewattachment);
        gr_view.query();
        var attachments = [];
        while (gr_view.next()) {
            var attachment = {
                sys_id: gr_view.sys_id.toString(),
                file_name: gr_view.file_name.toString(),
                icon: getIcon(gr_view.content_type.toString()),
                viewUrl: '/sys_attachment.do?sys_id=' + gr_view.getValue('sys_id')
            }
            attachments.push(attachment);
        }
        data.attachments = attachments;
    }

    else if (input && input.deleteattachment) {
        var gr_delete = new GlideRecord('sys_attachment');
        if (gr_delete.get(input.deleteattachment)) {
            gr_delete.deleteRecord();
        }
    }

    else if (input && input.action == 'delete_row') {
        var gr_delete_multiple = new GlideRecord('sys_attachment');
        gr_delete_multiple.addQuery('table_sys_id', input.row_id);
        gr_delete_multiple.query();
        gr_delete_multiple.deleteMultiple();
    }

    var invoice_row = {
        id: uuidv4(),
        invoice_pdf_date: '',
        invoice_number: '',
        invoice_amount: '',
        attachmentCount: 0,
        invoice_error: 'Invalid currency format or must be positive.',
        show_invoice_error: false
    };

    data.invoice_rows = [invoice_row];
    data.credit_rows = [];

    function getIcon(content_type) {
        return FILE_ICON_MAP[content_type] || "fa-file-o";
    }

    function uuidv4() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0,
                v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }
})();






// Client Script

api.controller = function($scope, $uibModal, nowAttachmentHandler, spUtil) {
    var c = this;
    var g_form = $scope.page.g_form;

    // Helper functions for mandatory field validation
    function isDateFilled(dateValue) {
        if (!dateValue) return false;
        if (dateValue === '') return false;
        if (dateValue instanceof Date) {
            return !isNaN(dateValue.getTime());
        }
        if (typeof dateValue === 'string') {
            return dateValue.length > 0 && dateValue !== 'mm/dd/yyyy';
        }
        return false;
    }

    function isAmountFilled(amount, type) {
        if (!amount || amount === '') return false;
        if (type === 'credit' && amount === '-') return false;
        var cleanAmount = amount.replace(/[,$-]/g, '');
        return cleanAmount.length > 0;
    }

    $scope.isDateFilled = isDateFilled;
    $scope.isAmountFilled = isAmountFilled;

    $scope.hideAddInvoiceButton = false;

    // Add new invoice group (invoice + optional credit slot)
    $scope.addInvoiceGroup = function() {
        var invoice_row = {
            id: uuidv4(),
            invoice_pdf_date: '',
            invoice_number: '',
            invoice_amount: '',
            attachmentCount: 0,
            invoice_error: 'Invalid currency format or must be positive.',
            show_invoice_error: false
        };
        
        c.data.invoice_rows.push(invoice_row);
        
        // Add placeholder for potential credit at this index
        var credit_placeholder = {
            id: uuidv4(),
            has_credit: false,
            invoice_pdf_date: '',
            invoice_number: '',
            invoice_amount: '-',
            attachmentCount: 0,
            invoice_error: 'Invalid currency format or must be negative.',
            show_invoice_error: false,
            show_group_error: false,
            currentTotal: ''
        };
        
        c.data.credit_rows.push(credit_placeholder);
        refreshMandatoryFilled();
    };

    // Add credit at specific index
    $scope.addCreditAtIndex = function(index) {
        if (!c.data.credit_rows[index]) {
            c.data.credit_rows[index] = {
                id: uuidv4(),
                has_credit: false,
                invoice_pdf_date: '',
                invoice_number: '',
                invoice_amount: '-',
                attachmentCount: 0,
                invoice_error: 'Invalid currency format or must be negative.',
                show_invoice_error: false,
                show_group_error: false,
                currentTotal: ''
            };
        }
        
        c.data.credit_rows[index].has_credit = true;
        c.data.credit_rows[index].invoice_pdf_date = '';
        c.data.credit_rows[index].invoice_number = '';
        c.data.credit_rows[index].invoice_amount = '-';
        c.data.credit_rows[index].attachmentCount = 0;
        refreshMandatoryFilled();
    };

    // Remove credit at specific index
    $scope.removeCreditAtIndex = function(index) {
        if (c.data.credit_rows[index]) {
            // Delete attachments
            if (c.data.credit_rows[index].id) {
                c.server.get({
                    action: 'delete_row',
                    row_id: c.data.credit_rows[index].id
                });
            }
            
            c.data.credit_rows[index].has_credit = false;
            c.data.credit_rows[index].invoice_pdf_date = '';
            c.data.credit_rows[index].invoice_number = '';
            c.data.credit_rows[index].invoice_amount = '-';
            c.data.credit_rows[index].attachmentCount = 0;
            c.data.credit_rows[index].show_invoice_error = false;
            c.data.credit_rows[index].show_group_error = false;
            c.data.credit_rows[index].currentTotal = '';
            $scope.refreshVariables();
        }
    };

    // Delete entire invoice group (invoice + credit)
    $scope.deleteInvoiceGroup = function(index) {
        // Delete invoice attachments
        c.server.get({
            action: 'delete_row',
            row_id: c.data.invoice_rows[index].id
        });
        
        // Delete credit attachments if credit exists
        if (c.data.credit_rows[index] && c.data.credit_rows[index].has_credit) {
            c.server.get({
                action: 'delete_row',
                row_id: c.data.credit_rows[index].id
            });
        }
        
        c.data.invoice_rows.splice(index, 1);
        c.data.credit_rows.splice(index, 1);
        $scope.refreshVariables();
    };

    function setupAttachmentHandler() {
        $scope.attachmentHandler = new nowAttachmentHandler(appendDone, appendError);
        $scope.$on('dialog.upload_too_large.show', function(e) {
            $log.error($scope.data.largeAttachmentMsg);
            spUtil.addErrorMessage($scope.data.largeAttachmentMsg);
        });
    }

    setupAttachmentHandler();

    // Watch for partial_pay_indicator changes
    $scope.$watch(function() {
        return g_form.getValue('partial_pay_indicator');
    }, function(newValue, oldValue) {
        if (newValue === 'Yes') {
            $scope.hideAddInvoiceButton = true;
            
            if (c.data.invoice_rows.length > 1) {
                for (var i = c.data.invoice_rows.length - 1; i > 0; i--) {
                    c.server.get({
                        action: 'delete_row',
                        row_id: c.data.invoice_rows[i].id
                    });
                    
                    if (c.data.credit_rows[i] && c.data.credit_rows[i].has_credit) {
                        c.server.get({
                            action: 'delete_row',
                            row_id: c.data.credit_rows[i].id
                        });
                    }
                    
                    c.data.invoice_rows.splice(i, 1);
                    c.data.credit_rows.splice(i, 1);
                }
                
                $scope.refreshVariables();
            }
        } else {
            $scope.hideAddInvoiceButton = false;
        }
    });

    $scope.$watch(function() {
        return g_form.getValue('invoice_account_toggle');
    }, function(newValue, oldValue) {
        if (newValue !== oldValue && oldValue !== undefined) {
            $scope.refreshVariables();
        }
    });

    function appendDone() {
        _updateAttachmentCounter(c.data.current_row_id, 'increment');
        $scope.fetchAttachments(c.data.current_row_id);
    }

    function appendError(error) {
        gs.error(error.msg + error.fileName);
    }

    $scope.setCurrentID = function(row_id, $event) {
        c.data.current_row_id = row_id;
        $scope.fetchAttachments(row_id);
        openModal('add-invoice-attachment', '');
    };

    $scope.fetchAttachments = function(row_id) {
        c.server.get({
            viewattachment: row_id
        }).then(function(response) {
            c.data.attachments = response.data.attachments;
            c.data.current_row_id = row_id;
        });
    };

    $scope.prepareAttachment = function($event) {
        var sizeLimit = 1024 * 1024 * 24;
        var current_row_id = c.data.current_row_id.toString();
        $scope.attachmentHandler.setParams('x_banun_submit_a_0_new_invoice_submission', current_row_id, sizeLimit);
        $scope.attachmentHandler.openSelector($event);
    };

    $scope.deleteAttachment = function(attachment_id) {
        c.server.get({
            deleteattachment: attachment_id
        }).then(function(response) {
            _updateAttachmentCounter(c.data.current_row_id, 'decrement');
            $scope.fetchAttachments(c.data.current_row_id);
        });
    };

    function _updateAttachmentCounter(row_id, action) {
        var allRows = c.data.invoice_rows.concat(c.data.credit_rows);
        for (var i = 0; i < allRows.length; i++) {
            if (allRows[i].id == row_id) {
                if (action == "increment") {
                    allRows[i].attachmentCount++;
                }
                if (action == "decrement") {
                    allRows[i].attachmentCount--;
                }
            }
        }
        refreshMandatoryFilled();
    }

    function openModal(template, size, callback) {
        callback = callback || false;
        c.modalInstance = $uibModal.open({
            templateUrl: template,
            scope: $scope,
            size: size
        });
        if (callback) {
            c.closedModal = c.modalInstance.closed.then(function() {
                callback();
            });
        }
    }

    $scope.closeModal = function() {
        c.modalInstance.close();
    };

    function uuidv4() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0,
                v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    function refreshMandatoryFilled() {
        var invoice_mandatory_filled = 0;
        var credit_mandatory_filled = 0;

        for (var i = 0; i < c.data.invoice_rows.length; i++) {
            var row = c.data.invoice_rows[i];
            if (isDateFilled(row.invoice_pdf_date) && 
                row.invoice_number != '' && 
                isAmountFilled(row.invoice_amount, 'invoice') && 
                row.attachmentCount > 0) {
                invoice_mandatory_filled++;
            }
        }

        // Count credits that are active (has_credit = true)
        var activeCreditCount = 0;
        for (var j = 0; j < c.data.credit_rows.length; j++) {
            if (c.data.credit_rows[j] && c.data.credit_rows[j].has_credit) {
                activeCreditCount++;
                var creditRow = c.data.credit_rows[j];
                if (isDateFilled(creditRow.invoice_pdf_date) && 
                    creditRow.invoice_number != '' && 
                    isAmountFilled(creditRow.invoice_amount, 'credit') && 
                    creditRow.attachmentCount > 0) {
                    credit_mandatory_filled++;
                }
            }
        }

        var allInvoicesFilled = (invoice_mandatory_filled == c.data.invoice_rows.length);
        var allCreditsFilled = (activeCreditCount === 0 || credit_mandatory_filled == activeCreditCount);
        
        // Check for group errors
        var hasGroupErrors = false;
        for (var k = 0; k < c.data.credit_rows.length; k++) {
            if (c.data.credit_rows[k] && c.data.credit_rows[k].show_group_error) {
                hasGroupErrors = true;
                break;
            }
        }
        
        g_form.setValue('mandatory_filled', (allInvoicesFilled && allCreditsFilled && invoiceAmountFilled && !hasGroupErrors));
    }

    $scope.refreshVariables = function() {
        var invoice_numbers = '';
        var invoice_amounts = '';
        var invoice_attachment_ids = '';
        var invoice_pdf_dates = '';
        
        var has_credit_flags = '';
        var credit_numbers = '';
        var credit_amounts = '';
        var credit_attachment_ids = '';
        var credit_pdf_dates = '';

        // Process invoice rows
        for (var i = 0; i < c.data.invoice_rows.length; i++) {
            var invRow = c.data.invoice_rows[i];
            
            // Convert Date object to YYYY-MM-DD string
            var dateString = '';
            if (invRow.invoice_pdf_date) {
                if (invRow.invoice_pdf_date instanceof Date) {
                    var d = invRow.invoice_pdf_date;
                    var month = String(d.getMonth() + 1).padStart(2, '0');
                    var day = String(d.getDate()).padStart(2, '0');
                    var year = d.getFullYear();
                    dateString = year + '-' + month + '-' + day;
                } else {
                    dateString = invRow.invoice_pdf_date;
                }
            }
            
            invoice_numbers += invRow.invoice_number + ',';
            invoice_amounts += invRow.invoice_amount + ',';
            invoice_attachment_ids += invRow.id + ',';
            invoice_pdf_dates += dateString + ',';
            
            // Track if this invoice has a credit
            var hasCredit = c.data.credit_rows[i] && c.data.credit_rows[i].has_credit;
            has_credit_flags += hasCredit + ',';
            
            // If this invoice has a credit, add credit data
            if (hasCredit) {
                var credRow = c.data.credit_rows[i];
                
                var creditDateString = '';
                if (credRow.invoice_pdf_date) {
                    if (credRow.invoice_pdf_date instanceof Date) {
                        var d = credRow.invoice_pdf_date;
                        var month = String(d.getMonth() + 1).padStart(2, '0');
                        var day = String(d.getDate()).padStart(2, '0');
                        var year = d.getFullYear();
                        creditDateString = year + '-' + month + '-' + day;
                    } else {
                        creditDateString = credRow.invoice_pdf_date;
                    }
                }
                
                credit_numbers += credRow.invoice_number + ',';
                credit_amounts += credRow.invoice_amount + ',';
                credit_attachment_ids += credRow.id + ',';
                credit_pdf_dates += creditDateString + ',';
            }
        }

        // Remove trailing commas
        invoice_numbers = invoice_numbers.slice(0, -1);
        invoice_amounts = invoice_amounts.slice(0, -1);
        invoice_attachment_ids = invoice_attachment_ids.slice(0, -1);
        invoice_pdf_dates = invoice_pdf_dates.slice(0, -1);
        has_credit_flags = has_credit_flags.slice(0, -1);
        credit_numbers = credit_numbers.slice(0, -1);
        credit_amounts = credit_amounts.slice(0, -1);
        credit_attachment_ids = credit_attachment_ids.slice(0, -1);
        credit_pdf_dates = credit_pdf_dates.slice(0, -1);

        g_form.setValue('invoice_numbers', invoice_numbers);
        g_form.setValue('invoice_amounts', invoice_amounts);
        g_form.setValue('attachment_ids', invoice_attachment_ids);
        g_form.setValue('invoice_pdf_dates', invoice_pdf_dates);
        
        g_form.setValue('has_credit_flags', has_credit_flags);
        g_form.setValue('credit_numbers', credit_numbers);
        g_form.setValue('credit_amounts', credit_amounts);
        g_form.setValue('credit_attachment_ids', credit_attachment_ids);
        g_form.setValue('credit_pdf_dates', credit_pdf_dates);

        validateAllGroups();
        refreshMandatoryFilled();
    };

    function validateAllGroups() {
        for (var i = 0; i < c.data.invoice_rows.length; i++) {
            if (c.data.credit_rows[i] && c.data.credit_rows[i].has_credit) {
                validateGroup(i);
            }
        }
    }

    function validateGroup(index) {
        var invoiceAmt = parseFloat(c.data.invoice_rows[index].invoice_amount.replace(/[,$]/g, '')) || 0;
        var creditAmt = parseFloat(c.data.credit_rows[index].invoice_amount.replace(/[,$]/g, '')) || 0;
        
        // Calculate current total for this group
        var total = invoiceAmt + creditAmt;
        c.data.credit_rows[index].currentTotal = '$' + total.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        
        // Credit is negative, check if total is <= 0 (invalid)
        if (total <= 0) {
            c.data.credit_rows[index].show_group_error = true;
        } else {
            c.data.credit_rows[index].show_group_error = false;
        }
    }

    var invoiceAmountFilled = false;

    $scope.validateCurrency = function(value, field, row_id, type, index) {
        var currencyRegex = /^-?(((\d{1,3},?)(\d{3},?)+|\d{1,3})|\d+)(\.\d{2})?$/;
        var allRows = c.data.invoice_rows.concat(c.data.credit_rows);

        if (!value || !currencyRegex.test(value)) {
            invoiceAmountFilled = false;
            for (var i = 0; i < allRows.length; i++) {
                if (allRows[i].id == row_id) {
                    allRows[i].show_invoice_error = true;
                }
            }
        } else {
            var numValue = parseFloat(value.replace(/,/g, ''));
            
            if ((type === 'invoice' && numValue <= 0) || (type === 'credit' && numValue >= 0)) {
                invoiceAmountFilled = false;
                for (var j = 0; j < allRows.length; j++) {
                    if (allRows[j].id == row_id) {
                        allRows[j].show_invoice_error = true;
                    }
                }
            } else {
                invoiceAmountFilled = true;
                for (var k = 0; k < allRows.length; k++) {
                    if (allRows[k].id == row_id) {
                        allRows[k].show_invoice_error = false;
                    }
                }
            }
        }
        
        if (typeof index !== 'undefined') {
            validateGroup(index);
        }
        refreshMandatoryFilled();
    };
};
