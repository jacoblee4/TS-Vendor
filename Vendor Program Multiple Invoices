//HTML

<h4>Invoice Submissions</h4>

<div class="form-group" ng-repeat="group in data.invoiceGroups track by group.id">
  <hr style="border-width: 2px; margin-top: 30px; margin-bottom: 20px;" ng-if="$index > 0">
  
  <h5 style="margin-bottom: 15px;">Invoice/Account #{{$index + 1}}</h5>
  
  <div class="row">
    <!-- LEFT SIDE: Invoice Section -->
    <div class="col-md-6">
      <div style="border-right: 1px solid #ddd; padding-right: 15px;">
        <h6 style="font-weight: bold; margin-bottom: 15px;">Invoice Details</h6>
        
        <span class="fa fa-asterisk mandatory" ng-class="{'mandatory-filled': isDateFilled(group.invoice_pdf_date)}"
              title="Required" style="padding-right: 0.25em;" aria-label="Required"></span>
        <label>Invoice Date</label>
        <div class="info-text">Enter the Invoice Date located on the PDF</div>
        <input type="date" class="form-control" ng-model="group.invoice_pdf_date"/>
        
        <div style="margin-top:7px;">
          <span class="fa fa-asterisk mandatory" ng-class="{'mandatory-filled': group.invoice_number != ''}"
                title="Required" style="padding-right: 0.25em;" aria-label="Required"></span>
          <label>Invoice/Account Number</label>
          <input type="text" class="form-control" ng-model="group.invoice_number" ng-change="refreshVariables()"/>
        </div>
        
        <div style="margin-top:7px;">
          <span class="fa fa-asterisk mandatory" ng-class="{'mandatory-filled': isAmountFilled(group.invoice_amount, 'invoice')}"
                title="Required" style="padding-right: 0.25em;" aria-label="Required"></span>
          <label>Invoice/Account Amount</label>
          <input type="text" class="form-control" ng-model="group.invoice_amount" 
                 ng-change="refreshVariables()" 
                 ng-blur="validateCurrency(group.invoice_amount, 'invoice', group.id)"/>
          <div class="error-message" ng-show="group.show_invoice_error">{{group.invoice_error}}</div>
        </div>
        
        <div class="text-right" style="margin-top:15px;">
          <button class="panel-button sp-attachment-add btn btn-link attachment-btn"
                  ng-click="setCurrentID(group.invoice_attachment_id, $event);">
            <span class="fa fa-asterisk mandatory" ng-class="{'mandatory-filled': group.invoice_attachmentCount > 0}"
                  title="Required" style="padding-right: 0.25em;" aria-label="Required"></span>
            <span class="glyphicon glyphicon-paperclip">
              <span class="badge badge-error" ng-if="group.invoice_attachmentCount > 0">{{group.invoice_attachmentCount}}</span>
            </span>
          </button>
        </div>
      </div>
    </div>
    
    <!-- RIGHT SIDE: Credit Section -->
    <div class="col-md-6">
      <div style="padding-left: 15px;">
        <!-- Add Credit Button (shown when no credit) -->
        <div ng-if="!group.has_credit">
          <button class="btn btn-danger" ng-click="addCreditToGroup(group)">
            <span class="glyphicon glyphicon-plus"></span> Add Credit Memo
          </button>
        </div>
        
        <!-- Credit Fields (shown when credit added) -->
        <div ng-if="group.has_credit">
          <h6 style="font-weight: bold; margin-bottom: 15px;">Credit Memo Details</h6>
          
          <span class="fa fa-asterisk mandatory" ng-class="{'mandatory-filled': isDateFilled(group.credit_pdf_date)}"
                title="Required" style="padding-right: 0.25em;" aria-label="Required"></span>
          <label>Invoice Date</label>
          <div class="info-text">Enter the Invoice Date located on the PDF</div>
          <input type="date" class="form-control" ng-model="group.credit_pdf_date"/>
          
          <div style="margin-top:7px;">
            <span class="fa fa-asterisk mandatory" ng-class="{'mandatory-filled': group.credit_number != ''}"
                  title="Required" style="padding-right: 0.25em;" aria-label="Required"></span>
            <label>Credit Memo Invoice/Account Number</label>
            <input type="text" class="form-control" ng-model="group.credit_number" ng-change="refreshVariables()"/>
          </div>
          
          <div style="margin-top:7px;">
            <span class="fa fa-asterisk mandatory" ng-class="{'mandatory-filled': isAmountFilled(group.credit_amount, 'credit')}"
                  title="Required" style="padding-right: 0.25em;" aria-label="Required"></span>
            <label>Credit Memo Amount</label>
            <input type="text" class="form-control" ng-model="group.credit_amount" 
                   ng-change="refreshVariables()" 
                   ng-blur="validateCurrency(group.credit_amount, 'credit', group.id)"/>
            <div class="error-message" ng-show="group.show_credit_error">{{group.credit_error}}</div>
          </div>
          
          <div class="text-right" style="margin-top:15px;">
            <button class="panel-button sp-attachment-add btn btn-link attachment-btn"
                    ng-click="setCurrentID(group.credit_attachment_id, $event);">
              <span class="fa fa-asterisk mandatory" ng-class="{'mandatory-filled': group.credit_attachmentCount > 0}"
                    title="Required" style="padding-right: 0.25em;" aria-label="Required"></span>
              <span class="glyphicon glyphicon-paperclip">
                <span class="badge badge-error" ng-if="group.credit_attachmentCount > 0">{{group.credit_attachmentCount}}</span>
              </span>
            </button>
          </div>
          
          <div style="margin-top:15px;">
            <button class="btn btn-warning btn-sm" ng-click="removeCreditFromGroup(group)">
              <span class="glyphicon glyphicon-remove"></span> Remove Credit Memo
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Per-group error message -->
  <div class="warning-bubble" ng-show="group.show_group_error" style="margin-top: 15px;">
    <span class="glyphicon glyphicon-warning-sign" style="margin-right: 8px;"></span>
    The credit amount cannot exceed invoice amount. Current total: <strong>{{group.currentTotal}}</strong>
  </div>
  
  <!-- Delete Invoice Group Button -->
  <div class="text-right" style="margin-top: 15px;" ng-if="data.invoiceGroups.length > 1">
    <button class="btn btn-danger" ng-click="deleteInvoiceGroup($index, group)">
      <span class="glyphicon glyphicon-trash"></span> Delete Invoice/Account Group
    </button>
  </div>
</div>

<button class='btn btn-primary' id='AddInvoiceGroup' ng-click="addInvoiceGroup()" 
        ng-hide="hideAddInvoiceButton" style="margin-top: 20px;">
  <span class="glyphicon glyphicon-plus"></span> Add Another Invoice/Account
</button>


// CSS

.attachment-btn {
    margin-left: 0;
}
.badge-error {
	background-color: #b94a48;
}

.glyphicon {
	text-align: center;
	vertical-align: middle;
}

.badge {
    font-size: .35em;
    position: absolute;
    top: -.75em;
    right: -.75em;
    width: 2em;
    height: 2em;
    text-align: center;
}

.a-viewurl {
	color: black;
}

.a-viewurl:hover {
	text-decoration: underline;
}

.error-message{
 	color:#d9534f;
	font-style: italic;
    font-size: smaller;
    background-color: transparent;
    padding: 0 !important;
    margin: 0 !important;
}

.info-text {
    color: #666;
    font-size: 0.9em;
    font-style: italic;
    margin-bottom: 5px;
}

.warning-bubble {
    background-color: #fcf8e3;
    border: 1px solid #faebcc;
    border-radius: 4px;
    color: #8a6d3b;
    padding: 12px 15px;
    margin-top: 15px;
    font-size: 1em;
    display: flex;
    align-items: center;
}

.warning-bubble .glyphicon {
    color: #f0ad4e;
}







// Server Script

(function() {

    var FILE_ICON_MAP = {
        'image/jpeg': 'fa-file-image-o',
        'image/pjpeg': 'fa-file-image-o',
        'image/tiff': 'fa-file-image-o',
        'image/png': 'fa-file-image-o',
        'image/gif': 'fa-file-image-o',
        'application/zip': 'fa-file-archive-o',
        'application/x-compressed': 'fa-file-archive-o',
        'application/x-zip-compressed': 'fa-file-archive-o',
        'application/pdf': 'fa-file-pdf-o',
        'application/vnd.openxmlformats-officedoc': 'fa-file-word-o',
        'application/msword': 'fa-file-word-o',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'fa-file-word-o',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.template': 'fa-file-word-o',
        'application/excel': 'fa-file-excel-o',
        'application/vnd.ms-excel': 'fa-file-excel-o',
        'application/x-excel': 'fa-file-excel-o',
        'application/x-msexcel': 'fa-file-excel-o',
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'fa-file-excel-o',
        'application/vnd.openxmlformats-officedocument.spreadsheetml.template': 'fa-file-excel-o',
        'application/powerpoint': 'fa-file-powerpoint-o',
        'application/vnd.ms-powerpoint': 'fa-file-powerpoint-o',
        'application/vnd.openxmlformats-officedocument.presentationml.presentation': 'fa-file-powerpoint-o',
        'application/vnd.openxmlformats-officedocument.presentationml.template': 'fa-file-powerpoint-o',
        'application/vnd.openxmlformats-officedocument.presentationml.slideshow': 'fa-file-powerpoint-o',
        'ppt': 'fa-file-powerpoint-o',
        'pptx': 'fa-file-powerpoint-o',
        'doc': 'fa-file-word-o',
        'docx': 'fa-file-word-o',
        'xls': 'fa-file-excel-o',
        'xlsx': 'fa-file-excel-o'
    };

    if (input && input.viewattachment) {
        var gr_view = new GlideRecord('sys_attachment');
        gr_view.addQuery('table_sys_id', input.viewattachment);
        gr_view.query();
        var attachments = [];
        while (gr_view.next()) {
            var attachment = {
                sys_id: gr_view.sys_id.toString(),
                file_name: gr_view.file_name.toString(),
                icon: getIcon(gr_view.content_type.toString()),
                viewUrl: '/sys_attachment.do?sys_id=' + gr_view.getValue('sys_id')
            };
            attachments.push(attachment);
        }
        data.attachments = attachments;
    }

    else if (input && input.deleteattachment) {
        var gr_delete = new GlideRecord('sys_attachment');
        if (gr_delete.get(input.deleteattachment)) {
            gr_delete.deleteRecord();
        }
    }

    else if (input && input.action == 'delete_attachments') {
        var gr_delete_multiple = new GlideRecord('sys_attachment');
        gr_delete_multiple.addQuery('table_sys_id', input.attachment_id);
        gr_delete_multiple.query();
        gr_delete_multiple.deleteMultiple();
    }

    // Initialize with one invoice group
    var invoiceGroup = {
        id: uuidv4(),
        invoice_pdf_date: '',
        invoice_number: '',
        invoice_amount: '',
        invoice_attachment_id: uuidv4(),
        invoice_attachmentCount: 0,
        invoice_error: 'Invalid currency format or must be positive.',
        show_invoice_error: false,
        
        has_credit: false,
        credit_pdf_date: '',
        credit_number: '',
        credit_amount: '-',
        credit_attachment_id: '',
        credit_attachmentCount: 0,
        credit_error: 'Invalid currency format or must be negative.',
        show_credit_error: false,
        
        show_group_error: false
    };

    data.invoiceGroups = [invoiceGroup];

    function getIcon(content_type) {
        return FILE_ICON_MAP[content_type] || "fa-file-o";
    }

    function uuidv4() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0,
                v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }
})();





// Client Script

api.controller = function($scope, $uibModal, nowAttachmentHandler, spUtil, $timeout) {
    var c = this;
    var g_form = $scope.page.g_form;

    // Helper functions for mandatory field validation
    function isDateFilled(dateValue) {
        if (!dateValue) return false;
        if (dateValue === '') return false;
        if (dateValue instanceof Date) {
            return !isNaN(dateValue.getTime());
        }
        if (typeof dateValue === 'string') {
            return dateValue.length > 0 && dateValue !== 'mm/dd/yyyy';
        }
        return false;
    }

    function isAmountFilled(amount, type) {
        if (!amount || amount === '') return false;
        if (type === 'credit' && amount === '-') return false;
        var cleanAmount = amount.replace(/[,$-]/g, '');
        return cleanAmount.length > 0;
    }

	g_form.onSubmit(function() {
    $scope.refreshVariables();
    return true; // Allow submission to proceed
});

    $scope.isDateFilled = isDateFilled;
    $scope.isAmountFilled = isAmountFilled;

    $scope.hideAddInvoiceButton = false;

    // Add new invoice group
    $scope.addInvoiceGroup = function() {
        var group = {
            id: uuidv4(),
            invoice_pdf_date: '',
            invoice_number: '',
            invoice_amount: '',
            invoice_attachment_id: uuidv4(),
            invoice_attachmentCount: 0,
            invoice_error: 'Invalid currency format or must be positive.',
            show_invoice_error: false,
            
            has_credit: false,
            credit_pdf_date: '',
            credit_number: '',
            credit_amount: '-',
            credit_attachment_id: '',
            credit_attachmentCount: 0,
            credit_error: 'Invalid currency format or must be negative.',
            show_credit_error: false,
            
            show_group_error: false
        };
        c.data.invoiceGroups.push(group);
        refreshMandatoryFilled();
    };

    // Delete invoice group
    $scope.deleteInvoiceGroup = function(index, group) {
        // Delete invoice attachments
        c.server.get({
            action: 'delete_attachments',
            attachment_id: group.invoice_attachment_id
        });
        
        // Delete credit attachments if credit exists
        if (group.has_credit && group.credit_attachment_id) {
            c.server.get({
                action: 'delete_attachments',
                attachment_id: group.credit_attachment_id
            });
        }
        
        c.data.invoiceGroups.splice(index, 1);
        $scope.refreshVariables();
    };

    // Add credit to specific group
    $scope.addCreditToGroup = function(group) {
        group.has_credit = true;
        group.credit_attachment_id = uuidv4();
        group.credit_pdf_date = '';
        group.credit_number = '';
        group.credit_amount = '-';
        group.credit_attachmentCount = 0;
        refreshMandatoryFilled();
    };

    // Remove credit from specific group
    $scope.removeCreditFromGroup = function(group) {
        // Delete credit attachments
        if (group.credit_attachment_id) {
            c.server.get({
                action: 'delete_attachments',
                attachment_id: group.credit_attachment_id
            });
        }
        
        group.has_credit = false;
        group.credit_pdf_date = '';
        group.credit_number = '';
        group.credit_amount = '-';
        group.credit_attachment_id = '';
        group.credit_attachmentCount = 0;
        group.show_credit_error = false;
        group.show_group_error = false;
        $scope.refreshVariables();
    };

    function setupAttachmentHandler() {
        $scope.attachmentHandler = new nowAttachmentHandler(appendDone, appendError);
        $scope.$on('dialog.upload_too_large.show', function(e) {
            $log.error($scope.data.largeAttachmentMsg);
            spUtil.addErrorMessage($scope.data.largeAttachmentMsg);
        });
    }

    setupAttachmentHandler();

    // Watch for partial_pay_indicator changes
    $scope.$watch(function() {
        return g_form.getValue('partial_pay_indicator');
    }, function(newValue, oldValue) {
        if (newValue === 'Yes') {
            $scope.hideAddInvoiceButton = true;
            
            if (c.data.invoiceGroups.length > 1) {
                for (var i = c.data.invoiceGroups.length - 1; i > 0; i--) {
                    var group = c.data.invoiceGroups[i];
                    
                    c.server.get({
                        action: 'delete_attachments',
                        attachment_id: group.invoice_attachment_id
                    });
                    
                    if (group.has_credit && group.credit_attachment_id) {
                        c.server.get({
                            action: 'delete_attachments',
                            attachment_id: group.credit_attachment_id
                        });
                    }
                    
                    c.data.invoiceGroups.splice(i, 1);
                }
                
                $scope.refreshVariables();
            }
        } else {
            $scope.hideAddInvoiceButton = false;
        }
    });

    $scope.$watch(function() {
        return g_form.getValue('invoice_account_toggle');
    }, function(newValue, oldValue) {
        if (newValue !== oldValue && oldValue !== undefined) {
            $scope.refreshVariables();
        }
    });

    function appendDone() {
        _updateAttachmentCounter(c.data.current_attachment_id, 'increment');
        $scope.fetchAttachments(c.data.current_attachment_id);
    }

    function appendError(error) {
        gs.error(error.msg + error.fileName);
    }

    $scope.setCurrentID = function(attachment_id, $event) {
        c.data.current_attachment_id = attachment_id;
        $scope.fetchAttachments(attachment_id);
        openModal('add-invoice-attachment', '');
    };

    $scope.fetchAttachments = function(attachment_id) {
        c.server.get({
            viewattachment: attachment_id
        }).then(function(response) {
            c.data.attachments = response.data.attachments;
            c.data.current_attachment_id = attachment_id;
        });
    };

    $scope.prepareAttachment = function($event) {
        var sizeLimit = 1024 * 1024 * 24;
        var current_attachment_id = c.data.current_attachment_id.toString();
        $scope.attachmentHandler.setParams('x_banun_submit_a_0_new_invoice_submission', current_attachment_id, sizeLimit);
        $scope.attachmentHandler.openSelector($event);
    };

    $scope.deleteAttachment = function(attachment_id) {
        c.server.get({
            deleteattachment: attachment_id
        }).then(function(response) {
            _updateAttachmentCounter(c.data.current_attachment_id, 'decrement');
            $scope.fetchAttachments(c.data.current_attachment_id);
        });
    };

    function _updateAttachmentCounter(attachment_id, action) {
        for (var i = 0; i < c.data.invoiceGroups.length; i++) {
            var group = c.data.invoiceGroups[i];
            
            if (group.invoice_attachment_id == attachment_id) {
                if (action == "increment") {
                    group.invoice_attachmentCount++;
                } else if (action == "decrement") {
                    group.invoice_attachmentCount--;
                }
            }
            
            if (group.has_credit && group.credit_attachment_id == attachment_id) {
                if (action == "increment") {
                    group.credit_attachmentCount++;
                } else if (action == "decrement") {
                    group.credit_attachmentCount--;
                }
            }
        }
        refreshMandatoryFilled();
    }

    function openModal(template, size, callback) {
        callback = callback || false;
        c.modalInstance = $uibModal.open({
            templateUrl: template,
            scope: $scope,
            size: size
        });
        if (callback) {
            c.closedModal = c.modalInstance.closed.then(function() {
                callback();
            });
        }
    }

    $scope.closeModal = function() {
        c.modalInstance.close();
    };

    function uuidv4() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0,
                v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    function refreshMandatoryFilled() {
        var allGroupsValid = true;

        for (var i = 0; i < c.data.invoiceGroups.length; i++) {
            var group = c.data.invoiceGroups[i];
            
            // Check invoice fields
            var invoiceFilled = isDateFilled(group.invoice_pdf_date) && 
                                group.invoice_number != '' && 
                                isAmountFilled(group.invoice_amount, 'invoice') && 
                                group.invoice_attachmentCount > 0;
            
            // Check credit fields if credit exists
            var creditFilled = true;
            if (group.has_credit) {
                creditFilled = isDateFilled(group.credit_pdf_date) && 
                               group.credit_number != '' && 
                               isAmountFilled(group.credit_amount, 'credit') && 
                               group.credit_attachmentCount > 0;
            }
            
            // Validate this group
            var groupValid = invoiceFilled && creditFilled && !group.show_group_error;
            
            if (!groupValid) {
                allGroupsValid = false;
            }
        }

        g_form.setValue('mandatory_filled', allGroupsValid);
    }

   $scope.refreshVariables = function() {
    var invoice_numbers = '';
    var invoice_amounts = '';
    var invoice_attachment_ids = '';
    var invoice_pdf_dates = '';
    
    var has_credit_flags = '';
    var credit_numbers = '';
    var credit_amounts = '';
    var credit_attachment_ids = '';
    var credit_pdf_dates = '';

    // Process each invoice group
    for (var i = 0; i < c.data.invoiceGroups.length; i++) {
        var group = c.data.invoiceGroups[i];
        
        // Convert Date object to YYYY-MM-DD string for invoice
        var invDateString = '';
        if (group.invoice_pdf_date) {
            if (group.invoice_pdf_date instanceof Date) {
                var d = group.invoice_pdf_date;
                var month = String(d.getMonth() + 1).padStart(2, '0');
                var day = String(d.getDate()).padStart(2, '0');
                var year = d.getFullYear();
                invDateString = year + '-' + month + '-' + day;
            } else {
                invDateString = group.invoice_pdf_date;
            }
        }
        
        // Add invoice data
        invoice_numbers += group.invoice_number + ',';
        invoice_amounts += group.invoice_amount + ',';
        invoice_attachment_ids += group.invoice_attachment_id + ',';
        invoice_pdf_dates += invDateString + ',';
        
        // Add credit flag and data
        has_credit_flags += group.has_credit + ',';
        
        if (group.has_credit) {
            // Convert Date object to YYYY-MM-DD string for credit
            var credDateString = '';
            if (group.credit_pdf_date) {
                if (group.credit_pdf_date instanceof Date) {
                    var d = group.credit_pdf_date;
                    var month = String(d.getMonth() + 1).padStart(2, '0');
                    var day = String(d.getDate()).padStart(2, '0');
                    var year = d.getFullYear();
                    credDateString = year + '-' + month + '-' + day;
                } else {
                    credDateString = group.credit_pdf_date;
                }
            }
            
            credit_numbers += group.credit_number + ',';
            credit_amounts += group.credit_amount + ',';
            credit_attachment_ids += group.credit_attachment_id + ',';
            credit_pdf_dates += credDateString + ',';
        }
    }

    // Remove trailing commas
    invoice_numbers = invoice_numbers.slice(0, -1);
    invoice_amounts = invoice_amounts.slice(0, -1);
    invoice_attachment_ids = invoice_attachment_ids.slice(0, -1);
    invoice_pdf_dates = invoice_pdf_dates.slice(0, -1);
    has_credit_flags = has_credit_flags.slice(0, -1);
    credit_numbers = credit_numbers.slice(0, -1);
    credit_amounts = credit_amounts.slice(0, -1);
    credit_attachment_ids = credit_attachment_ids.slice(0, -1);
    credit_pdf_dates = credit_pdf_dates.slice(0, -1);

    // WRAP ALL g_form.setValue CALLS IN $timeout TO PREVENT UI BLOCKING
    $timeout(function() {
        g_form.setValue('invoice_numbers', invoice_numbers);
        g_form.setValue('invoice_amounts', invoice_amounts);
        g_form.setValue('attachment_ids', invoice_attachment_ids);
        g_form.setValue('invoice_pdf_dates', invoice_pdf_dates);
        
        g_form.setValue('has_credit_flags', has_credit_flags);
        g_form.setValue('credit_numbers', credit_numbers);
        g_form.setValue('credit_amounts', credit_amounts);
        g_form.setValue('credit_attachment_ids', credit_attachment_ids);
        g_form.setValue('credit_pdf_dates', credit_pdf_dates);
        
        validateAllGroups();
        refreshMandatoryFilled();
    }, 0);
};

    function validateAllGroups() {
        for (var i = 0; i < c.data.invoiceGroups.length; i++) {
            validateGroup(c.data.invoiceGroups[i]);
        }
    }

    function validateGroup(group) {
        if (group.has_credit) {
            var invoiceAmt = parseFloat(group.invoice_amount.replace(/[,$]/g, '')) || 0;
            var creditAmt = parseFloat(group.credit_amount.replace(/[,$]/g, '')) || 0;
            
            // Calculate current total for this group
            var total = invoiceAmt + creditAmt;
            group.currentTotal = '$' + total.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            
            // Credit is negative, check if total is <= 0 (invalid)
            if (total <= 0) {
                group.show_group_error = true;
            } else {
                group.show_group_error = false;
            }
        } else {
            group.show_group_error = false;
            group.currentTotal = '';
        }
    }

    $scope.validateCurrency = function(value, type, id) {
        var currencyRegex = /^-?(((\d{1,3},?)(\d{3},?)+|\d{1,3})|\d+)(\.\d{2})?$/;

        if (!value || !currencyRegex.test(value)) {
            setErrorForField(id, type, true);
        } else {
            var numValue = parseFloat(value.replace(/,/g, ''));
            
            if ((type === 'invoice' && numValue <= 0) || (type === 'credit' && numValue >= 0)) {
                setErrorForField(id, type, true);
            } else {
                setErrorForField(id, type, false);
            }
        }
        
        validateAllGroups();
        refreshMandatoryFilled();
    };

    function setErrorForField(id, type, showError) {
        for (var i = 0; i < c.data.invoiceGroups.length; i++) {
            var group = c.data.invoiceGroups[i];
            
            if (type === 'invoice' && group.id == id) {
                group.show_invoice_error = showError;
            } else if (type === 'credit' && group.id == id) {
                group.show_credit_error = showError;
            }
        }
    }
};
