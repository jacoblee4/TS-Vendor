var VendorProgramPortalUtilsBase = Class.create();
VendorProgramPortalUtilsBase.prototype = {
    initialize: function() {},

    getUserInfo: function(sys_id) {
        return this._getUserInfo(sys_id);
    },

    getTotalNumberOfRecords: function(table, query) {
        return this._getTotalNumberOfRecords(table, query);
    },

    getVendorTasks: function(vendorID) {
        return this._getVendorTasks(vendorID);
    },

    getUserNameMaxLength: function() {
        return this._getUserNameMaxLength();
    },

    vendorContactHasAccess: function(gr, userInfo) {
        userInfo = userInfo || this._getUserInfo(gs.getUserID());
        if (!userInfo.isVendorContact)
            return false;
        return true;
    },

    /**
     * Constructs the complete invoice number based on business rules
     * @param {GlideRecord} gr - The invoice submission record
     * @returns {String} The constructed invoice number
     */
    constructInvoiceNumber: function(gr) {
        // Start with the original invoice/account number entered by user
        var baseNumber = gr.getValue('original_invoice_number') || '';
        
        if (!baseNumber) {
            gs.warn('VendorProgramPortalUtils: original_invoice_number is empty for record ' + gr.getUniqueValue());
            return '';
        }

        var constructedNumber = baseNumber;

        // Step 1: Add partial payment suffix if applicable
        // Only for invoices (not credits) with partial pay indicator
        if (gr.getValue('partial_pay_indicator') == 'Yes' && 
            gr.getValue('invoice_credit_variable') == 'invoice') {
            
            var partialType = gr.getValue('partialpay_type');
            
            if (partialType == 'additional_payment') {
                constructedNumber += '_BAL';
            } else if (partialType == 'final_payment') {
                constructedNumber += '_FINAL';
            }
            // initial_payment leaves it as is (no suffix)
        }

        // Step 2: Add _MMYY suffix if toggle is set to account_number
        if (gr.getValue('invoice_account_toggle') == 'account_number') {
            var mmyy = this._getMMYYFromDate(gr.getValue('invoice_pdf_date'));
            if (mmyy) {
                constructedNumber += '_' + mmyy;
            }
        }

        // Step 3: Ensure uniqueness by checking for duplicates and appending letters
        var uniqueNumber = this.getUniqueInvoiceNumber(constructedNumber, gr.getUniqueValue());

        return uniqueNumber;
    },

    /**
     * Ensures the invoice number is unique by appending letters (A, B, C...) if needed
     * @param {String} proposedNumber - The proposed invoice number before duplicate checking
     * @param {String} currentSysId - The sys_id of the current record (to exclude from duplicate check)
     * @returns {String} A unique invoice number
     */
    getUniqueInvoiceNumber: function(proposedNumber, currentSysId) {
        var baseNumber = proposedNumber;  // This is the fully constructed number (123_BAL, 123_0125, etc.)
        var duplicateSuffix = '';          // We append A, B, C here for duplicates
        
        // Keep checking and appending letters until we find a unique number
        while (this._isDuplicateInvoiceNumber(baseNumber + duplicateSuffix, currentSysId)) {
            duplicateSuffix = this._getNextDuplicateSuffix(duplicateSuffix);
        }
        
        return baseNumber + duplicateSuffix;
    },

    /**
     * Gets the next duplicate suffix letter (A -> B -> C ... Z -> AA -> AB...)
     * @param {String} currentSuffix - The current duplicate suffix (empty string, 'A', 'B', etc.)
     * @returns {String} The next suffix in sequence
     */
    _getNextDuplicateSuffix: function(currentSuffix) {
        // If no suffix yet, start with 'A'
        if (!currentSuffix || currentSuffix.length === 0) {
            return 'A';
        }
        
        var lastChar = currentSuffix.slice(-1);
        
        // If last character is A-Y, increment it
        if (lastChar >= 'A' && lastChar < 'Z') {
            var nextChar = String.fromCharCode(lastChar.charCodeAt(0) + 1);
            return currentSuffix.slice(0, -1) + nextChar;
        } 
        // If last character is Z, append another A (Z -> ZA -> ZB... or A -> AA)
        else if (lastChar == 'Z') {
            return currentSuffix + 'A';
        }
        
        // Fallback - should never reach here
        return currentSuffix + 'A';
    },

    /**
     * Checks if the invoice number already exists in the system
     * @param {String} invoiceNumber - The invoice number to check
     * @param {String} currentSysId - The sys_id of the current record to exclude
     * @returns {Boolean} True if duplicate exists, false otherwise
     */
    _isDuplicateInvoiceNumber: function(invoiceNumber, currentSysId) {
        var gr = new GlideRecord('x_banun_submit_a_0_new_invoice_submission');
        gr.addQuery('invoice_number', invoiceNumber);
        
        // Exclude the current record from duplicate check
        if (currentSysId) {
            gr.addQuery('sys_id', '!=', currentSysId);
        }
        
        // Exclude rejected records from duplicate check
        gr.addQuery('approval', '!=', 'rejected');
        gr.query();

        return gr.hasNext();
    },

    /**
     * Converts a date to MMYY format
     * @param {String} dateValue - The date value from invoice_pdf_date
     * @returns {String} Date in MMYY format (e.g., "0125" for January 2025)
     */
    _getMMYYFromDate: function(dateValue) {
        if (!dateValue) {
            return '';
        }

        var gdt = new GlideDateTime(dateValue);
        var month = gdt.getMonthLocalTime().toString();
        var year = gdt.getYearLocalTime().toString();

        // Pad month to 2 digits and get last 2 digits of year
        month = month.length == 1 ? '0' + month : month;
        year = year.slice(-2);

        return month + year;
    },

    //Only one argument is used at a time.
    _getVendorTasks: function(vendorID) {
        var userID = this._getUserInfo(gs.getUserID());

        if (!vendorID && !userID)
            return {};

        var gr = new GlideRecord('x_banun_submit_a_0_new_invoice_submission');

        if (vendorID) {
            gr.addQuery('requested_by.vendor', vendorID);
        } else if (userID) {
            gr.addQuery('requested_by', userID);
        }

        gr.orderByDesc('sys_created_on');
        gr.query();

        var tasks = [];

        while (gr.next()) {
            if (!this.vendorContactHasAccess(gr, userID))
                continue;

            var task = {};
            task.sys_id = gr.sys_id + '';
            task.number = gr.number + '';
            task.invoice_pdf_date = gr.invoice_pdf_date.getDisplayValue();
            task.invoice_date = gr.invoice_date.getDisplayValue();
            task.supplier_name = gr.supplier_name.getDisplayValue();
            task.invoice_number = gr.invoice_number + '';
            task.invoice_total = gr.invoice_total.getDisplayValue();
            task.grand_total = gr.grand_total.getDisplayValue();
            task.invoice_status = gr.invoice_status + '';
            task.invoice_statusDisplay = gr.invoice_status.getDisplayValue();
            task.requester = gr.requested_by.getDisplayValue();
            tasks.push(task);
        }
        return tasks;
    },

    _getTotalNumberOfRecords: function(table, query) {
        var rec = new GlideAggregate(table);
        rec.addEncodedQuery(query);
        rec.addAggregate('COUNT');
        rec.query();
        var recCount = 0;
        if (rec.next())
            recCount = rec.getAggregate('COUNT');
        return recCount;
    },

    _getUserInfo: function(sys_id) {
        var user = {};

        var userID = sys_id ? sys_id : gs.getUserID();
        user.userID = userID;
        if (userID == '5136503cc611227c0183e96598c4f706') { //Guest
            user.userType = 'guest';
            return user;
        }

        //Get the user type: primary_contact, contact, non_contact
        var gr = new GlideRecord('x_banun_submit_a_0_vendor_program_contacts');
        if (!gr.get(userID)) {
            user.userType = 'non_contact';
            return user;
        }

        user.firstName = gr.first_name + '';
        user.lastName = gr.last_name + '';
        user.name = gr.name + '';
        user.userName = gr.user_name + '';
        user.companyID = gr.company + '';
        user.company = gr.getDisplayValue('company');
        user.vendor = gr.vendor + '';
        user.vendorName = gr.getDisplayValue('vendor');
        user.isVendorContact = true;

        return user;
    },

    _getUserNameMaxLength: function() {
        var defaultMaxLength = 40;

        var gr = new GlideRecord('sys_dictionary');
        gr.addQuery('name', 'sys_user');
        gr.addQuery('element', 'user_name');
        gr.query();
        if (gr.next())
            return parseInt(gr.max_length);
        return defaultMaxLength;
    },

    type: 'VendorProgramPortalUtilsBase'
};
