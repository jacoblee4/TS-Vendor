(function executeRule(current, previous /*null when async*/) {
    
    // PART 1: Construct invoice number (existing logic)
    if (!current.original_invoice_number) {
        if (current.invoice_number) {
            current.original_invoice_number = current.invoice_number;
        } else {
            gs.warn('Invoice submission ' + current.number + ' is missing original_invoice_number');
            return;
        }
    }

    var utils = new VendorProgramPortalUtilsBase();
    var constructedNumber = utils.constructInvoiceNumber(current);
    current.invoice_number = constructedNumber;

    // PART 2: If this is a credit with a parent, sync related fields from parent
    if (current.invoice_credit_variable == 'credit' && current.parent) {
        // Check if parent field changed or is being set for first time
        var parentChanged = current.parent.changes();
        
        if (parentChanged) {
            var parentInvoice = current.parent.getRefRecord();
            if (parentInvoice && parentInvoice.isValidRecord()) {
                current.related_invoice_number = parentInvoice.getValue('invoice_number');
                current.related_pdf_date = parentInvoice.getValue('invoice_pdf_date');
                
                gs.info('Credit ' + current.number + ' synced related fields from parent invoice ' + 
                        parentInvoice.getValue('number'));
            }
        }
    }

})(current, previous);
